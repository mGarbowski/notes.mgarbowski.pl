<!doctype html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>wyklad-11</title>
    <link rel="stylesheet" href="../style.css">

    <!--    Load mathjax from cdn to render latex equations-->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="prev-next-links">
    
    <div class="index-links-prev">
        <a href="wyklad-10.html">Poprzedni: wyklad-10.html</a>
    </div>
    

    
    <div class="index-links-next">
        <a href="wyklad-12.html">Następny: wyklad-12.html</a>
    </div>
    
    <div class="return-link">
        <a href="..">Powrót</a>
    </div>
</div>
<div class="container">
    <div class="index-links-wrapper">
        <h2>Sztuka wytwarzania oprogramowania</h2>
        <div class="index-links">
            <ul>
                
                <li><a href="kolokwium-01.html">kolokwium-01.html</a></li>
                
                <li><a href="kolokwium-02.html">kolokwium-02.html</a></li>
                
                <li><a href="wyklad-00.html">wyklad-00.html</a></li>
                
                <li><a href="wyklad-01.html">wyklad-01.html</a></li>
                
                <li><a href="wyklad-02.html">wyklad-02.html</a></li>
                
                <li><a href="wyklad-03.html">wyklad-03.html</a></li>
                
                <li><a href="wyklad-04.html">wyklad-04.html</a></li>
                
                <li><a href="wyklad-05.html">wyklad-05.html</a></li>
                
                <li><a href="wyklad-06.html">wyklad-06.html</a></li>
                
                <li><a href="wyklad-07.html">wyklad-07.html</a></li>
                
                <li><a href="wyklad-08.html">wyklad-08.html</a></li>
                
                <li><a href="wyklad-09.html">wyklad-09.html</a></li>
                
                <li><a href="wyklad-10.html">wyklad-10.html</a></li>
                
                <li><a href="wyklad-11.html">wyklad-11.html</a></li>
                
                <li><a href="wyklad-12.html">wyklad-12.html</a></li>
                
                <li><a href="wyklad-13.html">wyklad-13.html</a></li>
                
            </ul>
        </div>
    </div>
    <div class="content-wrapper">
        <main>
            <h1 id="współbieżność-2024-05-20">Współbieżność (2024-05-20)</h1>
<h2 id="aplikacja-wielowątkowa">Aplikacja wielowątkowa</h2>
<ul>
<li>Pozwala na reakcję na zlecenia użytkownka podczas przeprowadzania
obliczeń</li>
<li>Lepiej wykorzystuje dostępną moc obliczeniową</li>
<li>Może obsługiwać wiele zleceń równolegle</li>
<li>Poprawnie zaprojektowana jest szybsza a platformach
wieloprocesorowych</li>
</ul>
<p>Język programowania musi wspierać współbieżność (np. C++, Java)</p>
<h2 id="współbieżność-w-c">Współbieżność w C++</h2>
<ul>
<li>Należy używać bibliotek przeznaczonych do pracy wielowątkowej</li>
<li>Dostarcza mechanizmy tworzenia i synchronizacja w bibliotece
standardowej</li>
<li>Współdzielone
<ul>
<li>obiekty globalne</li>
<li>obiekty dynamiczne</li>
<li>zasoby systemu operacyjnego</li>
<li>kod wykonywany</li>
</ul></li>
<li>Niezależne
<ul>
<li>rejestry</li>
<li>ciąg wykonywanych instrukcji</li>
<li>stos</li>
<li>obiekty automatyczne (na stosie)</li>
</ul></li>
<li>Program ma zawsze jeden wątek (funkcja <code>main</code>)
<ul>
<li>może tworzyć kolejne wątki</li>
</ul></li>
<li>Trzeba zlinkować odpowiednią wersję biblioteki standardowej
(wielowątową)
<ul>
<li>w przeciwnym razie mogą wystąpić wyścigi</li>
<li>ustawiane przez flagę kompilatora</li>
</ul></li>
</ul>
<h3 id="stdthread"><code>std::thread</code></h3>
<ul>
<li>Przyjmuje uchwyt na funkcję główną wątku albo na funktor (obiekt z
zaimplementowanym operatorem wołania funkcyjnego)</li>
<li>Metoda <code>join</code> zawiesza bieżący wątek do zakończenia
wątku</li>
</ul>
<h2 id="wyścig-race-conditions">Wyścig (race conditions)</h2>
<ul>
<li>Wiele wątków pisze lub czyta ten sam obszar pamięci</li>
<li>Nie wiadomo jakie jest wzajemne rozłożenie w czasie instrukcji
wątków</li>
<li>Wyścig można wyeliminować tylko na etapie projektu</li>
<li>Rozwiązania
<ul>
<li>synchronizacja</li>
<li>operacje atomowe ## Problemy z tworzeniem aplikacji
wielowątkowych</li>
</ul></li>
<li>Błędy są niepowtarzalne - nie można przeprowadzić deterministycznych
testów</li>
<li>Różne zachowanie wersji debug i release</li>
</ul>
<h2 id="blokada-mutex">Blokada (mutex)</h2>
<ul>
<li>Sekcja krytyczna umieszczona między wywołaniem instrukcji
<code>lock</code> i <code>unlock</code></li>
<li>Wzorzec projektowy RAII
<ul>
<li><code>lock</code> wywołane w konstruktorze</li>
<li><code>unlock</code> wywołane w destruktorze</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Lock <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    Lock<span class="op">(</span>mutex <span class="op">&amp;</span>m<span class="op">)</span> <span class="op">:</span> <span class="va">m_</span><span class="op">(</span>m<span class="op">)</span> <span class="op">{</span><span class="va">m_</span><span class="op">.</span>lock<span class="op">();}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>Lock<span class="op">()</span> <span class="op">{</span><span class="va">m_</span><span class="op">.</span>unlock<span class="op">();}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    mutex <span class="op">&amp;</span><span class="va">m_</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>mutex m<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    Lock guard<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sekcja krytyczna</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// Zwolnienie zasobów</span></span></code></pre></div>
<h2 id="zakleszczenie">Zakleszczenie</h2>
<ul>
<li>Każdy z wątków czeka na jakiś inny, żaden nie może dalej pracować
<ul>
<li>1: a.lock()</li>
<li>2: b.lock()</li>
<li>2: a.lock()</li>
<li>1: b.lock()</li>
</ul></li>
<li>Rozwiązanie
<ul>
<li>zajmowanie blokad zawsze w tej samej kolejności</li>
<li>stosowanie innych mechanizmów synchronizacji</li>
</ul></li>
</ul>
<h2 id="kończenie-wątku">Kończenie wątku</h2>
<ul>
<li>Błędne jest przerwanie wątku z zewnątrz
<ul>
<li>nieustalony stan aplikacji</li>
<li>wątek mógł być wewnątrz sekcji krytycznej i jej nie zwolni</li>
</ul></li>
<li>Wątek musi zakończyć się sam</li>
<li>Wątek może przyjmować flagę i sprawdzać czy powinien sam się
zakończyć
<ul>
<li>flagę można ustawić z zewnątrz</li>
<li>wątek zewnętrzny zgłasza prośbę i czeka aż wątek sam się
zakończy</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Thread <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    thread<span class="op">():</span> <span class="va">finish_</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> finish<span class="op">()</span> <span class="op">{</span><span class="va">finish_</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="kw">operator</span><span class="op">()()</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">!</span><span class="va">finish_</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// sekcja krytyczna</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">volatile</span> <span class="dt">bool</span> <span class="va">finish_</span><span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h2 id="skalowalność">Skalowalność</h2>
<ul>
<li>Prawo Amdahla - przyspieszenie dla <span
class="math inline">\(p\)</span> procesów</li>
<li><span class="math inline">\(S(p) = \frac{1}{1-a+a/n}\)</span>
<ul>
<li><span class="math inline">\(a\)</span> część algorytmu, która może
podlegać zrównolegleniu</li>
<li>większa liczba procesów przyspiesza tylko część która może być
zrównoleglona</li>
</ul></li>
<li>Prawo Gustafsona-Barsisa
<ul>
<li>wraz ze wzrostem liczby procesorów można rozwiązywać coraz większe
instancje problemu</li>
<li>…</li>
</ul></li>
</ul>
<h3 id="wysoka-skalowalność">Wysoka skalowalność</h3>
<ul>
<li>Ścieżka szybka
<ul>
<li>nie występują blokady</li>
<li>odczyt lokalnych lub współdzielonych danych</li>
<li>zapis tylko lokalnych danych</li>
</ul></li>
<li>Ścieżka wolna
<ul>
<li>blokady</li>
<li>zapis współdzielonych danych</li>
</ul></li>
</ul>
<h2 id="podwójna-sprawdzanie">Podwójna sprawdzanie</h2>
<h3 id="poprawne-ale-nieefektywne">Poprawne ale nieefektywne</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Singleton<span class="op">&amp;</span> SIngleton<span class="op">::</span>getInstance<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>lock_guard guard<span class="op">(</span>mutex<span class="op">);</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>pInstance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        pInstance <span class="op">=</span> <span class="kw">new</span> Singleton<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">*</span>pInstance<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="efektywne---wzorzec-podwójnego-sprawdzania">Efektywne - wzorzec
podwójnego sprawdzania</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Singleton<span class="op">&amp;</span> SIngleton<span class="op">::</span>getInstance<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>pInstance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>lock_guard guard<span class="op">(</span>mutex<span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>pInstance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            pInstance <span class="op">=</span> <span class="kw">new</span> Singleton<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">*</span>pInstance<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Ścieżka szybka - nie wchodzi w zewnętrzny <code>if</code></p>
<p>Zakłada kolejność wykonania linii - przydział pamięci, konstruktor,
przypisanie Może być niepoprawny jeśli <code>pInstance</code> nie jest
<code>volatile</code> Sequence point w C++ to linia W praktyce to i tak
działa na wszystkich platformach</p>
<h2 id="wyjątki">Wyjątki</h2>
<ul>
<li>Wyjątki mogą być rzucane i wyłapywane w niezależnych wątkach</li>
<li>Wątek musi być wygenerowany i złapany w obrębie jednego wątku
<ul>
<li>nie może wyjść poza funkcję główną wyjątku</li>
</ul></li>
</ul>
<h2 id="wzorzec-monitora">Wzorzec monitora</h2>
<ul>
<li>Obiekt sam zapewnia, że metody mogą być wołane przez różne
wątki</li>
<li>Obiekt sam synchronizuje operacje, które tego wymagają</li>
</ul>
<h2 id="przetwarzanie-potokowe">Przetwarzanie potokowe</h2>
<ul>
<li>Algorytm składa się z kolejnych etapów, gdzie kolejny na swoje
wejście przyjmuje wyjście poprzedniego etapu</li>
<li>Wątki pozwalają wygodnie implementować taki model przetwarzania</li>
<li>Dane można podzielić na bloki i kolejne etapy przetwarzania
wykonywać współbieżnie</li>
<li>Wątki mają bufor wejściowy i wyjściowy - muszą je między sobą
synchronizować</li>
<li>Algorytm może sam dobrać wielkość porcji danych którą będzie
przetwarzać</li>
<li>Mechanizm wątków sprawia że kolejne etapy się między sobą równoważą
przez zapełnienianie buforów</li>
<li>Dwa kolejne kroki współdzielą bufor który może np implementować
wzorzec monitora</li>
</ul>

        </main>
    </div>
    <div class="table-of-contents">
        <nav id="TOC" role="doc-toc">
<ul>
<li><a href="#współbieżność-2024-05-20" id="toc-współbieżność-2024-05-20">Współbieżność (2024-05-20)</a>
<ul>
<li><a href="#aplikacja-wielowątkowa" id="toc-aplikacja-wielowątkowa">Aplikacja wielowątkowa</a></li>
<li><a href="#współbieżność-w-c" id="toc-współbieżność-w-c">Współbieżność w C++</a>
<ul>
<li><a href="#stdthread" id="toc-stdthread"><code>std::thread</code></a></li>
</ul></li>
<li><a href="#wyścig-race-conditions" id="toc-wyścig-race-conditions">Wyścig (race conditions)</a></li>
<li><a href="#blokada-mutex" id="toc-blokada-mutex">Blokada
(mutex)</a></li>
<li><a href="#zakleszczenie" id="toc-zakleszczenie">Zakleszczenie</a></li>
<li><a href="#kończenie-wątku" id="toc-kończenie-wątku">Kończenie
wątku</a></li>
<li><a href="#skalowalność" id="toc-skalowalność">Skalowalność</a>
<ul>
<li><a href="#wysoka-skalowalność" id="toc-wysoka-skalowalność">Wysoka
skalowalność</a></li>
</ul></li>
<li><a href="#podwójna-sprawdzanie" id="toc-podwójna-sprawdzanie">Podwójna sprawdzanie</a>
<ul>
<li><a href="#poprawne-ale-nieefektywne" id="toc-poprawne-ale-nieefektywne">Poprawne ale nieefektywne</a></li>
<li><a href="#efektywne---wzorzec-podwójnego-sprawdzania" id="toc-efektywne---wzorzec-podwójnego-sprawdzania">Efektywne - wzorzec
podwójnego sprawdzania</a></li>
</ul></li>
<li><a href="#wyjątki" id="toc-wyjątki">Wyjątki</a></li>
<li><a href="#wzorzec-monitora" id="toc-wzorzec-monitora">Wzorzec
monitora</a></li>
<li><a href="#przetwarzanie-potokowe" id="toc-przetwarzanie-potokowe">Przetwarzanie potokowe</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>
</body>
</html>